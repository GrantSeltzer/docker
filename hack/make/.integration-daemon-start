#!/bin/bash

# see test-integration-cli for example usage of this script

export PATH="$ABS_DEST/../dynbinary:$ABS_DEST/../binary:$ABS_DEST/../gccgo:$ABS_DEST/../dyngccgo:$PATH"

if ! command -v docker &> /dev/null; then
	echo >&2 'error: dynbinary or binary must be run before .integration-daemon-start'
	false
fi

# intentionally open a couple bogus file descriptors to help test that they get scrubbed in containers
exec 41>&1 42>&2

export DOCKER_GRAPHDRIVER=${DOCKER_GRAPHDRIVER:-vfs}
export DOCKER_USERLANDPROXY=${DOCKER_USERLANDPROXY:-true}

# example usage: DOCKER_STORAGE_OPTS="dm.basesize=20G,dm.loopdatasize=200G"
storage_params=""
if [ -n "$DOCKER_STORAGE_OPTS" ]; then
	IFS=','
	for i in ${DOCKER_STORAGE_OPTS}; do
		storage_params="--storage-opt $i $storage_params"
	done
	unset IFS
fi

# example usage: DOCKER_STORAGE_OPTS="dm.basesize=20G,dm.loopdatasize=200G"
extra_params=""
if [ "$DOCKER_REMAP_ROOT" ]; then
	extra_params="--userns-remap $DOCKER_REMAP_ROOT"
fi

SASLAUTHD=false
if test -n "$DOCKER_DAEMON_ARGS" ; then
	for dparam in $DOCKER_DAEMON_ARGS ; do
		case $dparam in
			htpasswd=*)
				HTPASSWD=`echo $dparam | cut -f2 -d=`
				;;
			libsasl2=*|libsasl2)
				SASLAUTHD=true
				;;
			keytab=*)
				KEYTAB=`echo $dparam | cut -f2 -d=`
				;;
		esac
	done
fi

if [ -z "$DOCKER_TEST_HOST" ]; then
	# Start apparmor if it is enabled
	if [ -e "/sys/module/apparmor/parameters/enabled" ] && [ "$(cat /sys/module/apparmor/parameters/enabled)" == "Y" ]; then
		# reset container variable so apparmor profile is applied to process
		# see https://github.com/docker/libcontainer/blob/master/apparmor/apparmor.go#L16
		export container=""
		(
			set -x
			/etc/init.d/apparmor start
		)
	fi
	if [ -n "$KEYTAB" ] ; then
		cat > /etc/krb5.conf <<- EOF
		[libdefaults]
		 default_realm = EXAMPLE.COM
		[realms]
		 EXAMPLE.COM = {
		  kdc = $HOSTNAME
		 }
		EOF
		(echo;echo)|(set -x;kdb5_util create -s -W)
		# unix sockets use the container's hostname
		(set -x;kadmin.local -q "add_principal -randkey HTTP/$HOSTNAME")
		(set -x;kadmin.local -q "ktadd -k $KEYTAB HTTP/$HOSTNAME")
		# tcp sockets use "localhost"
		(set -x;kadmin.local -q "add_principal -randkey HTTP/localhost")
		(set -x;kadmin.local -q "ktadd -k $KEYTAB HTTP/localhost")
		(set -x;krb5kdc -P $(cd $DEST && pwd)/krb5kdc.pid)
		if [ -n "$DOCKER_AUTHN_USERID" ] && [ -n "$DOCKER_AUTHN_PASSWORD" ] ; then
			(set -x;kadmin.local -q "add_principal -pw $DOCKER_AUTHN_PASSWORD $DOCKER_AUTHN_USERID")
			echo $DOCKER_AUTHN_PASSWORD | (set -x;kinit $DOCKER_AUTHN_USERID)
			(set -x;kadmin.local -q "add_principal -pw $DOCKER_AUTHN_PASSWORD unprivileged-$DOCKER_AUTHN_USERID")
			echo $DOCKER_AUTHN_PASSWORD | (set -x;su -c "kinit unprivileged-$DOCKER_AUTHN_USERID" unprivilegeduser)
		fi
	fi
	if $SASLAUTHD ; then
		echo pwcheck_method:saslauthd > /usr/lib/sasl2/docker.conf
		echo saslauthd_path:$(cd $DEST && pwd)/mux >> /usr/lib/sasl2/docker.conf
		(set -x;saslauthd -c -a pam -m $(cd $DEST && pwd))
		if [ -n "$DOCKER_AUTHN_USERID" ] && [ -n "$DOCKER_AUTHN_PASSWORD" ] ; then
			crypt_password=`python -c 'import crypt; print crypt.crypt("'$DOCKER_AUTHN_PASSWORD'", "salt")'`
			(set -x;useradd -l $DOCKER_AUTHN_USERID -p "$crypt_password")
		fi
	fi
	if [ -n "$HTPASSWD" ] ; then
		if [ -n "$DOCKER_AUTHN_USERID" ] && [ -n "$DOCKER_AUTHN_PASSWORD" ] ; then
			(set -x;htpasswd -b -c $HTPASSWD $DOCKER_AUTHN_USERID $DOCKER_AUTHN_PASSWORD)
		fi
	fi

	export DOCKER_HOST="unix://$(cd "$DEST" && pwd)/docker.sock" # "pwd" tricks to make sure $DEST is an absolute path, not a relative one
	( set -x; exec \
		docker daemon --debug \
		--host "$DOCKER_HOST" \
		--storage-driver "$DOCKER_GRAPHDRIVER" \
		--pidfile "$DEST/docker.pid" \
		--userland-proxy="$DOCKER_USERLANDPROXY" \
		$storage_params \
		$extra_params \
		$DOCKER_DAEMON_ARGS \
			&> "$DEST/docker.log"
	) &
	# make sure that if the script exits unexpectedly, we stop this daemon we just started
	trap 'bundle .integration-daemon-stop' EXIT
else
	export DOCKER_HOST="$DOCKER_TEST_HOST"
fi

# give it a little time to come up so it's "ready"
tries=60
echo "INFO: Waiting for daemon to start..."
while ! docker version &> /dev/null; do
	(( tries-- ))
	if [ $tries -le 0 ]; then
		printf "\n"
		if [ -z "$DOCKER_HOST" ]; then
			echo >&2 "error: daemon failed to start"
			echo >&2 "  check $DEST/docker.log for details"
		else
			echo >&2 "error: daemon at $DOCKER_HOST fails to 'docker version':"
			docker version >&2 || true
			# Additional Windows CI debugging as this is a common error as of
			# January 2016
			if [ "$(go env GOOS)" = 'windows' ]; then	
				echo >&2 "Container log below:"
				echo >&2 "---"
				# Important - use the docker on the CI host, not the one built locally
				# which is currently in our path.
				! /c/bin/docker -H=$MAIN_DOCKER_HOST logs docker-$COMMITHASH
				echo >&2 "---"
			fi			
		fi
		false
	fi
	printf "."
	sleep 2
done
printf "\n"
